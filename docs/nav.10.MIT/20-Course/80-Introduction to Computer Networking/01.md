# 1. Networks

### connectivity
Internet的连接能力是指两台计算机互相连接并可以传输数据, 抽象来看就是两个应用之间的管道


### World Wide Web(HTTP)
HTTP是一个客户端（用户）和服务端（网站）之间请求和应答的标准，通常使用TCP协议。
- document-centric: 以文件为主

## 应用
### Network Applications
- 两台本地电脑通过网络读写数据
- dominant model: 双向可靠字节流连接
  - 一方读另一方写
  - 操作是双向的
  - 可靠(除非网络断开)
### BitTorrent
允许人们分享交换大文件, 不像 web里client从服务器请求文件, BitTorrent是客户从其他客户那里请求文件;

文件以切块形式存在

swarm(虫群?) - 分享同个种子的一群客户端

下载的时候需要一个 Torrent file, 描述了想要下载的文件信息

tracker: 持续记录 clients of the swarm

### skype
两台电脑互相请求数据
NAT（Network Address Translation，网络地址转换）: 在计算机网络中是一种在IP数据包通过路由器或防火墙时重写来源IP地址或目的IP地址的技术。这种技术被普遍使用在有多台主机但只通过一个公有IP地址访问互联网的私有网络中。它是一个方便且得到了广泛应用的技术。当然，NAT也让主机之间的通信变得复杂，导致了通信效率的降低。个人电脑常用;

一个Client behind NAT: 使用 Rendezvous server 跳过 NAT的限制, 另一个Client则直接发送数据至 Rendezvous server;
both clients behind NAT: Relay Server

## 4层模型
这里主要介绍 TCP/IP 4层模型

![TCP/IP4层模型]("~@assets/80/layerModel.jpg")

- 7层协议是指OSI七层协议模型，主要是：应用层（Application）、表示层（Presentation）、会话层（Session）、传输层（Transport）、网络层（Network）、数据链路层（Data Link）、物理层（Physical）

Each layer provide a services to the layer above.

### Link Layer: (Etherent, Wifi, DSL, 4G)

数据包（英语：Data packet），又称分组，是在分组交换网络中传输的格式化数据单位。

一个数据包（packet）分成两个部分，包括控制信息，也就是表头资料（header），和资料本身，也就是负载（payload）。header 一般包含寄件人和收件人的信息;

我们可以将一个数据包比作为一封信，表头资料相当于信封，而数据包的数据部分则相当于信的内容。和信不同的是，有时候一个大数据包可以分成多个小数据包。

###  Network: Internet Protocol(IP)
- IP 传递数据报(无保证)
- 数据报存在无序和丢失的问题
- 提供 unreliable datagram delivery service

### Transport: 最常见的传输协议为 TCP (Transmission control protocol), 用于解决网络层传输数据包无序和丢失的问题;
- 为应用层提供保证数据报顺序及重新发送的服务

不是所有应用都需要"数据顺序保证"
- UDP(用户数据报协议, User datagram protocol)
> UDP只提供数据的不可靠传递，它一旦把应用程序发给网络层的数据发送出去，就不保留数据备份（所以UDP有时候也被认为是不可靠的数据报协议）。UDP在IP数据报的头部仅仅加入了复用和数据校验字段。

UDP适用于不需要或在程序中执行错误检查和纠正的应用，它避免了协议栈中此类处理的开销。对时间有较高要求的应用程序通常使用UDP，因为丢弃数据包比等待或重传导致延迟更可取。

-RTP(Real time protocol) 等其他

### Application layer
http, smtp, ssh, ftp ...

## IP服务模型
IP 在互联网中属于"瓶颈", 不可避免的一环. IP服务模型一个很好的比喻是邮局服务
- Datagram
- Unreliable
- Best effort
- Connectionless: 无连接式通信，又译为免接式通信，一种通信传输模式，使用于电信及电脑网络中。在两个端点之间传递的消息，不需要事先安排，创建连线。

- Simple, dumb, minimal: Faster, more streamlined and lower cost to build and maintain;
- The end-to-end principle: Where possible, implement features in the end hosts.
- Allows a variety of reliable(or unreliable) services to be build on top.
- Works over any link layer: IP makes very few assumptions about the link layer below.

### 细节
1. 避免数据包无限循环(在数据报头加入 hop-count 字段来解决数据包在传输过程中由于某些原因在路由间无限循环 /Time to live, TTL field), 通常该数字是128, 其本身不解决无限循环的问题, 只是限制了上限次数
2. 数据包过长时会被切片
3. header checksum(校验)减少数据报被发送到错误地址的概率
4. 允许新版本IP(IPv4, 32位/ (IPv6, 128位)
5. 允许报头加入自定义字段

![IPV4数据报结构]("~@assets/80/IPv4_Datagram.jpg")

## packet的生命周期
以客户端发送请求到服务器为例
### 3次握手, 4次挥手

所谓三次握手(Three-way Handshake)，是指建立一个 TCP 连接时，需要客户端和服务器总共发送3个包。

三次握手的目的是连接服务器指定端口，建立 TCP 连接，并同步连接双方的序列号和确认号，交换 TCP 窗口大小信息。在 socket 编程中，客户端执行 connect() 时。将触发三次握手。

第一次握手(SYN=1, seq=x):
客户端发送一个 TCP 的 SYN 标志位置1的包，指明客户端打算连接的服务器的端口，以及初始序号 X,保存在包头的序列号(Sequence Number)字段里。

发送完毕后，客户端进入 SYN_SEND 状态。

第二次握手(SYN=1, ACK=1, seq=y, ACKnum=x+1):

服务器发回确认包(ACK)应答。即 SYN 标志位和 ACK 标志位均为1。服务器端选择自己 ISN 序列号，放到 Seq 域里，同时将确认序号(Acknowledgement Number)设置为客户的 ISN 加1，即X+1。 发送完毕后，服务器端进入 SYN_RCVD 状态。

第三次握手(ACK=1，ACKnum=y+1)

客户端再次发送确认包(ACK)，SYN 标志位为0，ACK 标志位为1，并且把服务器发来 ACK 的序号字段+1，放在确定字段中发送给对方，并且在数据段放写ISN的+1

发送完毕后，客户端进入 ESTABLISHED 状态，当服务器端接收到这个包时，也进入 ESTABLISHED 状态，TCP 握手结束。

三次握手的过程的示意图如下：

![IPV4数据报结构]("~@assets/80/tcp-connection-made-three-way-handshake.jpg")

TCP 的连接的拆除需要发送四个包，因此称为四次挥手(Four-way handshake)，也叫做改进的三次握手。客户端或服务器均可主动发起挥手动作，在 socket 编程中，任何一方执行 close() 操作即可产生挥手操作。

第一次挥手(FIN=1，seq=x)

假设客户端想要关闭连接，客户端发送一个 FIN 标志位置为1的包，表示自己已经没有数据可以发送了，但是仍然可以接受数据。

发送完毕后，客户端进入 FIN_WAIT_1 状态。

第二次挥手(ACK=1，ACKnum=x+1)

服务器端确认客户端的 FIN 包，发送一个确认包，表明自己接受到了客户端关闭连接的请求，但还没有准备好关闭连接。

发送完毕后，服务器端进入 CLOSE_WAIT 状态，客户端接收到这个确认包之后，进入 FIN_WAIT_2 状态，等待服务器端关闭连接。

第三次挥手(FIN=1，seq=y)

服务器端准备好关闭连接时，向客户端发送结束连接请求，FIN 置为1。

发送完毕后，服务器端进入 LAST_ACK 状态，等待来自客户端的最后一个ACK。

第四次挥手(ACK=1，ACKnum=y+1)

客户端接收到来自服务器端的关闭请求，发送一个确认包，并进入 TIME_WAIT状态，等待可能出现的要求重传的 ACK 包。

服务器端接收到这个确认包之后，关闭连接，进入 CLOSED 状态。

客户端等待了某个固定时间（两个最大段生命周期，2MSL，2 Maximum Segment Lifetime）之后，没有收到服务器端的 ACK ，认为服务器端已经正常关闭连接，于是自己也关闭连接，进入 CLOSED 状态。

四次挥手的示意图如下：

![]("~@assets/80/tcp-connection-closed-four-way-handshake.jpg")

参考: https://hit-alibaba.github.io/interview/basic/network/TCP.html
### 工具 wireshark, traceroute

## 原则: Packet Switching
定义: 
Packet: 一个以到达目的地为目标并携带所有必要信息的数据独立单位.
Packet Switching: 分别为各packet选择离开的link, 如果link是空闲的则发送, 否则保存数据包直到可发送状态;

### Simple packet forwarding
### Efficient sharing of links

流 flow: 一系列数据报属于同个端对端交流, eg TCP连接, No per-flow state required

突发: 是事件活动或事件频率的间歇性增加和减少;

Data traffic is bursty -> Statistical Multiplexing
统计复用是一种类型的通信链路共享非常相似的动态带宽分配。
- Packet Switching 允许流使用所有可用的链路容量
- Packet Switching 允许流使用分享链路容量




