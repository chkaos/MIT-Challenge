<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>21.Atomicity: Optimistic Concurrency Control | CHKAOS</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/note/egg.png">
    <meta name="description" content="My Note Collection">
    
    <link rel="preload" href="/note/assets/css/0.styles.ba589cc9.css" as="style"><link rel="preload" href="/note/assets/js/app.d5006f3d.js" as="script"><link rel="preload" href="/note/assets/js/2.65e5b2f3.js" as="script"><link rel="preload" href="/note/assets/js/102.5c217b08.js" as="script"><link rel="prefetch" href="/note/assets/js/10.ae2f2d04.js"><link rel="prefetch" href="/note/assets/js/100.c68d38be.js"><link rel="prefetch" href="/note/assets/js/101.fd3e754f.js"><link rel="prefetch" href="/note/assets/js/103.449bcd79.js"><link rel="prefetch" href="/note/assets/js/104.1b5b375d.js"><link rel="prefetch" href="/note/assets/js/105.a61b2017.js"><link rel="prefetch" href="/note/assets/js/106.e81cfff0.js"><link rel="prefetch" href="/note/assets/js/107.a75923b3.js"><link rel="prefetch" href="/note/assets/js/108.891948b3.js"><link rel="prefetch" href="/note/assets/js/109.a2545875.js"><link rel="prefetch" href="/note/assets/js/11.4ab4a5a3.js"><link rel="prefetch" href="/note/assets/js/110.6d0886e8.js"><link rel="prefetch" href="/note/assets/js/12.255d9150.js"><link rel="prefetch" href="/note/assets/js/13.794e7ac8.js"><link rel="prefetch" href="/note/assets/js/14.d32c7fdd.js"><link rel="prefetch" href="/note/assets/js/15.67cfbf95.js"><link rel="prefetch" href="/note/assets/js/16.3c73a976.js"><link rel="prefetch" href="/note/assets/js/17.8806b699.js"><link rel="prefetch" href="/note/assets/js/18.378bd860.js"><link rel="prefetch" href="/note/assets/js/19.48c8434f.js"><link rel="prefetch" href="/note/assets/js/20.1fdb582e.js"><link rel="prefetch" href="/note/assets/js/21.3e08c9be.js"><link rel="prefetch" href="/note/assets/js/22.810fe1a0.js"><link rel="prefetch" href="/note/assets/js/23.5ba70e2d.js"><link rel="prefetch" href="/note/assets/js/24.9681b927.js"><link rel="prefetch" href="/note/assets/js/25.c0e5deaa.js"><link rel="prefetch" href="/note/assets/js/26.aae4bdc7.js"><link rel="prefetch" href="/note/assets/js/27.7f17e5f5.js"><link rel="prefetch" href="/note/assets/js/28.61ef96a0.js"><link rel="prefetch" href="/note/assets/js/29.f8d63307.js"><link rel="prefetch" href="/note/assets/js/3.031640f4.js"><link rel="prefetch" href="/note/assets/js/30.817d5cd9.js"><link rel="prefetch" href="/note/assets/js/31.e4ea696a.js"><link rel="prefetch" href="/note/assets/js/32.aba63c9c.js"><link rel="prefetch" href="/note/assets/js/33.1aa6facd.js"><link rel="prefetch" href="/note/assets/js/34.69d2bc3f.js"><link rel="prefetch" href="/note/assets/js/35.f82bd55f.js"><link rel="prefetch" href="/note/assets/js/36.20a42b33.js"><link rel="prefetch" href="/note/assets/js/37.7ab6c748.js"><link rel="prefetch" href="/note/assets/js/38.04cf7e1e.js"><link rel="prefetch" href="/note/assets/js/39.87ad9256.js"><link rel="prefetch" href="/note/assets/js/4.0876ef1d.js"><link rel="prefetch" href="/note/assets/js/40.fa12820d.js"><link rel="prefetch" href="/note/assets/js/41.22bd816e.js"><link rel="prefetch" href="/note/assets/js/42.c107915c.js"><link rel="prefetch" href="/note/assets/js/43.983b5fc5.js"><link rel="prefetch" href="/note/assets/js/44.75f6ceb2.js"><link rel="prefetch" href="/note/assets/js/45.98830da6.js"><link rel="prefetch" href="/note/assets/js/46.550f0b22.js"><link rel="prefetch" href="/note/assets/js/47.8fbd223c.js"><link rel="prefetch" href="/note/assets/js/48.edf4b3f9.js"><link rel="prefetch" href="/note/assets/js/49.7508a3de.js"><link rel="prefetch" href="/note/assets/js/5.369c3e08.js"><link rel="prefetch" href="/note/assets/js/50.04715961.js"><link rel="prefetch" href="/note/assets/js/51.277d9998.js"><link rel="prefetch" href="/note/assets/js/52.ebc26274.js"><link rel="prefetch" href="/note/assets/js/53.471c676f.js"><link rel="prefetch" href="/note/assets/js/54.9e46fdf4.js"><link rel="prefetch" href="/note/assets/js/55.8a98c441.js"><link rel="prefetch" href="/note/assets/js/56.b5f6e00a.js"><link rel="prefetch" href="/note/assets/js/57.f6fb0c39.js"><link rel="prefetch" href="/note/assets/js/58.d92a7b7d.js"><link rel="prefetch" href="/note/assets/js/59.33c88c84.js"><link rel="prefetch" href="/note/assets/js/6.34251819.js"><link rel="prefetch" href="/note/assets/js/60.68db27af.js"><link rel="prefetch" href="/note/assets/js/61.ce3eefe1.js"><link rel="prefetch" href="/note/assets/js/62.a3e76ed5.js"><link rel="prefetch" href="/note/assets/js/63.b9084887.js"><link rel="prefetch" href="/note/assets/js/64.e1d868ed.js"><link rel="prefetch" href="/note/assets/js/65.0d77e0a0.js"><link rel="prefetch" href="/note/assets/js/66.fe465e07.js"><link rel="prefetch" href="/note/assets/js/67.76ca73a0.js"><link rel="prefetch" href="/note/assets/js/68.2498dd7c.js"><link rel="prefetch" href="/note/assets/js/69.f03ab615.js"><link rel="prefetch" href="/note/assets/js/7.273a5831.js"><link rel="prefetch" href="/note/assets/js/70.cad85a7e.js"><link rel="prefetch" href="/note/assets/js/71.5dcb8b9a.js"><link rel="prefetch" href="/note/assets/js/72.827102a3.js"><link rel="prefetch" href="/note/assets/js/73.315b5fe4.js"><link rel="prefetch" href="/note/assets/js/74.def8de65.js"><link rel="prefetch" href="/note/assets/js/75.a54fced2.js"><link rel="prefetch" href="/note/assets/js/76.6cae1891.js"><link rel="prefetch" href="/note/assets/js/77.12cb32b9.js"><link rel="prefetch" href="/note/assets/js/78.5994be50.js"><link rel="prefetch" href="/note/assets/js/79.bbc37f01.js"><link rel="prefetch" href="/note/assets/js/8.ba3fa28e.js"><link rel="prefetch" href="/note/assets/js/80.eeb65418.js"><link rel="prefetch" href="/note/assets/js/81.f876286e.js"><link rel="prefetch" href="/note/assets/js/82.a58003e1.js"><link rel="prefetch" href="/note/assets/js/83.13c9c65b.js"><link rel="prefetch" href="/note/assets/js/84.dca226ee.js"><link rel="prefetch" href="/note/assets/js/85.38911042.js"><link rel="prefetch" href="/note/assets/js/86.4f2e3cde.js"><link rel="prefetch" href="/note/assets/js/87.bb576b86.js"><link rel="prefetch" href="/note/assets/js/88.ba3e1a83.js"><link rel="prefetch" href="/note/assets/js/89.cc281bcf.js"><link rel="prefetch" href="/note/assets/js/9.557b7160.js"><link rel="prefetch" href="/note/assets/js/90.b68af197.js"><link rel="prefetch" href="/note/assets/js/91.a0945e77.js"><link rel="prefetch" href="/note/assets/js/92.accc5e5d.js"><link rel="prefetch" href="/note/assets/js/93.682fd046.js"><link rel="prefetch" href="/note/assets/js/94.c47d39d0.js"><link rel="prefetch" href="/note/assets/js/95.6363826c.js"><link rel="prefetch" href="/note/assets/js/96.36edf40e.js"><link rel="prefetch" href="/note/assets/js/97.75b6c735.js"><link rel="prefetch" href="/note/assets/js/98.8b5d3421.js"><link rel="prefetch" href="/note/assets/js/99.e03485fe.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.ba589cc9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><img src="/note/favicon.png" alt="CHKAOS" class="logo"> <span class="site-name can-hide">CHKAOS</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/MIT/" class="nav-link">
  Mit
</a></div><div class="nav-item"><a href="/note/Leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/note/Interview/" class="nav-link">
  Interview
</a></div><div class="nav-item"><a href="http://chkaos.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/chkaos/note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/MIT/" class="nav-link">
  Mit
</a></div><div class="nav-item"><a href="/note/Leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/note/Interview/" class="nav-link">
  Interview
</a></div><div class="nav-item"><a href="http://chkaos.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/chkaos/note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/note/mit/" aria-current="page" class="sidebar-link">前言</a></li><li><a href="/note/mit/schedule.html" class="sidebar-link">计划</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机科学与编程导论(python)</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机科学数学</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>电子工程与计算机科学导论1</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>电子工程与计算机科学导论2(交流网络)</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法导论</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>软件构造</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络导论</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>操作系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>分布式系统</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/mit/fen-bu-shi-xi-tong/" aria-current="page" class="sidebar-link">6.824 分布式系统</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/01.html" class="sidebar-link">Introduction</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/02.html" class="sidebar-link">2: Infrastructure: RPC and threads</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/03.html" class="sidebar-link">3.Fault Tolerance: primary/backup replication</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/04.html" class="sidebar-link">4.Fault Tolerance: FDS Case Study</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/05.html" class="sidebar-link">5: Fault Tolerance:Paxos</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/06.html" class="sidebar-link">6: Fault Tolerance:Raft</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/07.html" class="sidebar-link">7.Guest lecturer: Russ Cox (Google/Go)</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/08.html" class="sidebar-link">8.Case Studies: Replicated File System -- Harp</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/09.html" class="sidebar-link">9. Distributed Computing: Sequential consistency</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/10.html" class="sidebar-link">10.Distributed Computing: Relaxed consistency</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/11.html" class="sidebar-link">11.Disconnected Operation: Version Vectors and File Synchronization</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/12.html" class="sidebar-link">13.Disconnected Operation: Eventual Consistency</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/13.html" class="sidebar-link">13.MapReduce revisited</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/14.html" class="sidebar-link">14.Spark Case Study</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/15.html" class="sidebar-link">15.Guest lecturer: Wilson Hsieh (Google)</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/16.html" class="sidebar-link">16.Scaling Memcache at Facebook</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/17.html" class="sidebar-link">17.Case Studies: Relaxed Consistency-PNUTS</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/18.html" class="sidebar-link">18. Case Studies:Dynamo</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/19.html" class="sidebar-link">19.Distributed systems in the real world (Guest lecturer: Emil Sit)</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/20.html" class="sidebar-link">20.Atomicity: Two-Phase Commit</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/21.html" aria-current="page" class="active sidebar-link">21.Atomicity: Optimistic Concurrency Control</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/22.html" class="sidebar-link">22.Peer-to-peer: Trackerless Bittorrent and DHTs</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/23.html" class="sidebar-link">23.Peer-to-peer: Bitcoin</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/24.html" class="sidebar-link">24.Project demos</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_21-atomicity-optimistic-concurrency-control"><a href="#_21-atomicity-optimistic-concurrency-control" class="header-anchor">#</a> 21.Atomicity: Optimistic Concurrency Control</h1> <p>Paper: Efficient Optimistic Concurrency Control using Loosely
Synchronized Clocks, by Adya, Gruber, Liskov and Maheshwari.</p> <p>Why this paper?
to look at optimistic concurrency control (OCC)
OCC might help us get large scale, high speed, <em>and</em> good semantics</p> <p>Thor overview
[clients, client caches, servers A-M N-Z]
data sharded over servers
code runs in clients (not like Argus; not an RPC system)
clients read/write DB records from servers
clients cache data locally for fast access
on client cache miss, fetch from server</p> <p>Thor arrangement is fairly close to modern big web site habits
clients, local fast cache, slower DB servers
like Facebook/memcache paper
but Thor has much better semantics</p> <p>Thor programs use fully general transactions
multi-operation
serializable
so can do bank xfers w/o losing money, &amp;c</p> <p>Client caching makes transactions tricky
writes have to invalidatate cached copies
how to cope with reads of stale cached data?
how to cope with read-modify-write races?
clients could lock before using each record
but that's slow -- probably need to contact server
wrecks the whole point of fast local caching in clients
(though caching read locks might be OK, as in paper Eval)</p> <p>Thor uses optimistic concurrency control (OCC)
an idea from the early 1980s
just read and write the local copy
don't worry about other transactions until commit
when transaction wants to commit:
send read/write info to server for &quot;validation&quot;
validation decides if OK to commit -- if serializable
if yes, send invalidates to clients with cached copies of written records
if no, abort, discard writes
optimistic b/c hopes for no conflict
if turns out to be true, fast!
if false, validation can detect, but slow</p> <p>What should validation do?
it looks at what the executing transactions read and wrote
decides if there's a serial execution order that would have gotten
the same results as the actual concurrent execution
there are many OCC validation algorithms!
i will outline a few, leading up to Thor's</p> <p>Validation scheme #1
a single validation server
clients tell validation server the read and write VALUES
seen by each transaction that wants to commit
&quot;read set&quot; and &quot;write set&quot;
validation must decide:
would the results be serializable if we let these
transactions commit?
scheme #1 shuffles the transactions, looking for a serial order
in which each read sees the value written by the most
recent write; if one exists, the execution was serializable.</p> <p>Validation example 1:
initially, x=0 y=0 z=0
T1: Rx0 Wx1
T2: Rz0 Wz9
T3: Ry1 Rx1
T4: Rx0 Wy1
validation needs to decide if this execution (reads, writes)
is equivalent to some serial order
yes: one such order is T4, T1, T3, T2; says yes to all
(really T2 can go anywhere)
note this scheme is far more permissive than Thor's
e.g. it allows transactions to see uncommitted writes</p> <p>OCC is neat b/c transactions didn't need to lock!
so they can run quickly from client caches
just one msg exchange w/ validator per transaction
not one locking exchange per record used
OCC excellent for T2 which didn't conflict with anything
we got lucky for T1 T3 T4, which do conflict</p> <p>Validation example 2 -- sometimes must abort:
initially, x=0 y=0
T1: Rx0 Wx1
T2: Rx0 Wy1
T3: Ry0 Rx1
values not consistent w/ any serial order!
T1 -&gt; T3 (via x)
T3 -&gt; T2 (via y)
T2 -&gt; T1 (via x)
there's a cycle, so not the same as any serial execution
perhaps T3 read a stale y=0 from cache
or T2 read a style x=0 from cache
in this case validation can abort one of them
then others are OK to commit
e.g. abort T2
then T1, T3 is OK (but not T3, T1)</p> <p>How should client handle abort?
roll back the program (including writes to program variables)
re-run from start of transaction
hopefully won't be conflicts the second time
OCC is best when conflicts are uncommon!</p> <p>Do we need to validate read-only transactions?
example:
initially x=0 y=0
T1: Wx1
T2: Rx1 Wy2
T3: Ry2 Rx0
i.e. T3 read a stale x=0 from its cache, hadn't yet seen invalidate.
need to validate in order to abort T3.
other OCC schemes can avoid validating read-only transactions
keep multiple versions -- but Thor and my schemes don't</p> <p>Is OCC better than locking?
yes, if few conflicts
avoids lock msgs, clients don't have to wait for locks
no, if many conflicts
OCC aborts, must re-start, perhaps many times
locking waits
example: simultaneous increment
locking:
T1: Rx0 Wx1
T2: -------Rx1  Wx2
OCC:
T1: Rx0 Wx1
T2: Rx0 Wx1
fast but wrong; must abort one</p> <p>We really want <em>distributed</em> OCC validation
split storage and validation load over servers
each storage server sees only xactions that use its data
each storage server validates just its part of the xaction
two-phase commit (2PC) to check that they all say &quot;yes&quot;
only really commit if all relevant servers say &quot;yes&quot;</p> <p>Can we just distribute validation scheme #1?
imagine server S1 knows about x, server S2 knows about y
example 2 again
T1: Rx0 Wx1
T2: Rx0 Wy1
T3: Ry0 Rx1
S1 validates just x information:
T1: Rx0 Wx1
T2: Rx0
T3: Rx1
answer is &quot;yes&quot; (T2 T1 T3)
S2 validates just y information:
T2: Wy1
T3: Ry0
answer is &quot;yes&quot; (T3 T2)
but we know the real answer is &quot;no&quot;</p> <p>So simple distributed validation does not work
the validators must choose consistent orders!</p> <p>Validation scheme #2
Idea: client (or TC) chooses timestamp for committing xaction
from loosely synchronized clocks, as in Thor
validation checks that reads and writes are consistent with TS order
solves distrib validation problem:
timestamps tell the validators the order to check
so &quot;yes&quot; votes will refer to the same order</p> <p>Example 2 again, with timestamps:
T1@100: Rx0 Wx1
T2@110: Rx0 Wy1
T3@105: Ry0 Rx1
S1 validates just x information:
T1@100: Rx0 Wx1
T2@110: Rx0
T3@105: Rx1
timestamps say order must be T1, T3, T2
does not validate! T2 should have seen x=1
S2 validates just y information:
T2@110: Wy1
T3@105: Ry0
timstamps say order must be T3, T2
validates!
S1 says no, S2 says yes, two-phase commit coordinator will abort</p> <p>What have we given up by requiring timestamp order?
example:
T1@100: Rx0 Wx1
T2@50: Rx1 Wx2
T2 follows T1 in real time, and sees T1's write
but T2 will abort, since TS says T2 comes first, so T1 should have seen x=2
could have committed, since T1 then T2 works
this will happen if client clocks are too far off
if T1's client clock is ahead, or T2's behind
so: requiring TS order can abort unnecessarily
b/c validation no longer <em>searching</em> for an order that works
instead merely <em>checking</em> that TS order consistent w/ reads, writes
we've given up some optimism by requiring TS order
maybe not a problem if clocks closely synched
maybe not a problem if conflicts are rare</p> <p>Problem with schemes so far:
commit messages contained <em>values</em>, which can be big
could instead use version numbers to check whether
later xaction read earlier xaction's write
let's use writing xaction's TS as record version number</p> <p>Validation scheme #4
tag each DB record (and cached record) with TS of xation that last wrote it
validation requests carry TS of each record read</p> <p>Our example for scheme #4:
all values start with timestamp 0
T1@100: Rx@0 Wx
T2@110: Rx@0 Wy
T3@105: Ry@0 Rx@100
note:
reads have timestamp that was in read record, not value
writes don't include either value or timestamp
S1 validates just x information:
orders the transactions by timestamp:
T1@100: Rx@0 Wx
T3@105: Rx@100
T2@110: Rx@0
the question: does each read see the most recent write?
T3 is ok, but T2 is not
S2 validates just y information:
again, sort by TS, check each read saw latest write:
T3@105: Ry@0
T2@110: Wy
this does validate
so scheme #4 abort, correctly, reasoning only about version TSs</p> <p>what have we give up by thinking about version #s rather than values?
maybe version numbers are different but values are the same
e.g.
T1@100: Wx1
T2@110: Wx2
T3@120: Wx1
T4@130: Rx1@100
timestamps say we should abort T4 b/c read a stale version
should have read T3's write
so scheme #4 will abort
but T4 read the correct value -- x=1
so abort wasn't necessary</p> <p>Problem: per-record timestamp might use too much storage space
Thor wants to avoid space overhead
maybe important, maybe not</p> <p>Validation scheme #5
Thor's invalidation scheme: no timestamps on records
how can validation detect that a transaction read stale data?
it read stale data b/c earlier xaction's invalidation hadn't yet arrived!
so server can track invalidation msgs that might not have arrived yet
&quot;invalid set&quot; -- one per client
delete invalid set entry when client ACKs invalidation msg
server aborts committing xaction if it read record in client's invalid set
client aborts running xaction if it read record mentioned in invalidation</p> <p>Example use of invalid set
[timeline]
Client C1:
T2@105 ... Rx ... 2PC commit point
imagine that client acts as 2PC coordinator
Server:
VQ: T1@100 Wx
T1 committed, x in C1's invalid set
server has sent invalidation message to C1</p> <p>Three cases:</p> <ol><li>invalidation arrives before T2 reads
Rx will miss in client cache, read from data from server
client will (probably) return ACK before T2 commits
server won't abort T2</li> <li>invalidation arrives after T2 reads, before commit point
client will abort T2 in response to invalidation</li> <li>invalidation arrives after 2PC commit point
i.e. after all servers replied to prepare
this means the client was still in the invalid set when
the server tried to validate the transaction
so the server aborted, so the client will abort too
so: Thor's validation detects stale reads w/o timestamp on each record</li></ol> <p>Performance</p> <p>Look at Figure 5
AOCC is Thor
comparing to ACBL: client talks to srvr to get write-locks,
and to commit non-r/o xactions, but can cache read locks along with data
why does Thor (AOCC) have higher throughput?
fewer msgs; commit only, no lock msgs
why does Thor throughput go up for a while w/ more clients?
apparently a single client can't keep all resources busy
maybe due to network RTT?
maybe due to client processing time? or think time?
more clients -&gt; more parallel xactions -&gt; more completed
why does Thor throughput level off?
maybe 15 clients is enough to saturate server disk or CPU
abt 100 xactions/second, about right for writing disk
why does Thor throughput <em>drop</em> with many clients?
more clients means more concurrent xactions at any given time
more concurrency means more chance of conflict
for OCC, more conflict means more aborts, so more wasted CPU</p> <p>Conclusions
fast client caching + transactions would be excellent
distributed OCC very interesting, still an open research area
avoiding per-record version #s doesn't seem compelling
Thor's use of time was influential, e.g. Spanner</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">lastUpdate:</span> <span class="time">4/6/2021, 2:11:34 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/mit/fen-bu-shi-xi-tong/20.html" class="prev">
        20.Atomicity: Two-Phase Commit
      </a></span> <span class="next"><a href="/note/mit/fen-bu-shi-xi-tong/22.html">
        22.Peer-to-peer: Trackerless Bittorrent and DHTs
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.d5006f3d.js" defer></script><script src="/note/assets/js/2.65e5b2f3.js" defer></script><script src="/note/assets/js/102.5c217b08.js" defer></script>
  </body>
</html>
