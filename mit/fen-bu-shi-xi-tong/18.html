<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>18. Case Studies:Dynamo | CHKAOS</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/note/egg.png">
    <meta name="description" content="My Note Collection">
    
    <link rel="preload" href="/note/assets/css/0.styles.ba589cc9.css" as="style"><link rel="preload" href="/note/assets/js/app.d5006f3d.js" as="script"><link rel="preload" href="/note/assets/js/2.65e5b2f3.js" as="script"><link rel="preload" href="/note/assets/js/99.e03485fe.js" as="script"><link rel="prefetch" href="/note/assets/js/10.ae2f2d04.js"><link rel="prefetch" href="/note/assets/js/100.c68d38be.js"><link rel="prefetch" href="/note/assets/js/101.fd3e754f.js"><link rel="prefetch" href="/note/assets/js/102.5c217b08.js"><link rel="prefetch" href="/note/assets/js/103.449bcd79.js"><link rel="prefetch" href="/note/assets/js/104.1b5b375d.js"><link rel="prefetch" href="/note/assets/js/105.a61b2017.js"><link rel="prefetch" href="/note/assets/js/106.e81cfff0.js"><link rel="prefetch" href="/note/assets/js/107.a75923b3.js"><link rel="prefetch" href="/note/assets/js/108.891948b3.js"><link rel="prefetch" href="/note/assets/js/109.a2545875.js"><link rel="prefetch" href="/note/assets/js/11.4ab4a5a3.js"><link rel="prefetch" href="/note/assets/js/110.6d0886e8.js"><link rel="prefetch" href="/note/assets/js/12.255d9150.js"><link rel="prefetch" href="/note/assets/js/13.794e7ac8.js"><link rel="prefetch" href="/note/assets/js/14.d32c7fdd.js"><link rel="prefetch" href="/note/assets/js/15.67cfbf95.js"><link rel="prefetch" href="/note/assets/js/16.3c73a976.js"><link rel="prefetch" href="/note/assets/js/17.8806b699.js"><link rel="prefetch" href="/note/assets/js/18.378bd860.js"><link rel="prefetch" href="/note/assets/js/19.48c8434f.js"><link rel="prefetch" href="/note/assets/js/20.1fdb582e.js"><link rel="prefetch" href="/note/assets/js/21.3e08c9be.js"><link rel="prefetch" href="/note/assets/js/22.810fe1a0.js"><link rel="prefetch" href="/note/assets/js/23.5ba70e2d.js"><link rel="prefetch" href="/note/assets/js/24.9681b927.js"><link rel="prefetch" href="/note/assets/js/25.c0e5deaa.js"><link rel="prefetch" href="/note/assets/js/26.aae4bdc7.js"><link rel="prefetch" href="/note/assets/js/27.7f17e5f5.js"><link rel="prefetch" href="/note/assets/js/28.61ef96a0.js"><link rel="prefetch" href="/note/assets/js/29.f8d63307.js"><link rel="prefetch" href="/note/assets/js/3.031640f4.js"><link rel="prefetch" href="/note/assets/js/30.817d5cd9.js"><link rel="prefetch" href="/note/assets/js/31.e4ea696a.js"><link rel="prefetch" href="/note/assets/js/32.aba63c9c.js"><link rel="prefetch" href="/note/assets/js/33.1aa6facd.js"><link rel="prefetch" href="/note/assets/js/34.69d2bc3f.js"><link rel="prefetch" href="/note/assets/js/35.f82bd55f.js"><link rel="prefetch" href="/note/assets/js/36.20a42b33.js"><link rel="prefetch" href="/note/assets/js/37.7ab6c748.js"><link rel="prefetch" href="/note/assets/js/38.04cf7e1e.js"><link rel="prefetch" href="/note/assets/js/39.87ad9256.js"><link rel="prefetch" href="/note/assets/js/4.0876ef1d.js"><link rel="prefetch" href="/note/assets/js/40.fa12820d.js"><link rel="prefetch" href="/note/assets/js/41.22bd816e.js"><link rel="prefetch" href="/note/assets/js/42.c107915c.js"><link rel="prefetch" href="/note/assets/js/43.983b5fc5.js"><link rel="prefetch" href="/note/assets/js/44.75f6ceb2.js"><link rel="prefetch" href="/note/assets/js/45.98830da6.js"><link rel="prefetch" href="/note/assets/js/46.550f0b22.js"><link rel="prefetch" href="/note/assets/js/47.8fbd223c.js"><link rel="prefetch" href="/note/assets/js/48.edf4b3f9.js"><link rel="prefetch" href="/note/assets/js/49.7508a3de.js"><link rel="prefetch" href="/note/assets/js/5.369c3e08.js"><link rel="prefetch" href="/note/assets/js/50.04715961.js"><link rel="prefetch" href="/note/assets/js/51.277d9998.js"><link rel="prefetch" href="/note/assets/js/52.ebc26274.js"><link rel="prefetch" href="/note/assets/js/53.471c676f.js"><link rel="prefetch" href="/note/assets/js/54.9e46fdf4.js"><link rel="prefetch" href="/note/assets/js/55.8a98c441.js"><link rel="prefetch" href="/note/assets/js/56.b5f6e00a.js"><link rel="prefetch" href="/note/assets/js/57.f6fb0c39.js"><link rel="prefetch" href="/note/assets/js/58.d92a7b7d.js"><link rel="prefetch" href="/note/assets/js/59.33c88c84.js"><link rel="prefetch" href="/note/assets/js/6.34251819.js"><link rel="prefetch" href="/note/assets/js/60.68db27af.js"><link rel="prefetch" href="/note/assets/js/61.ce3eefe1.js"><link rel="prefetch" href="/note/assets/js/62.a3e76ed5.js"><link rel="prefetch" href="/note/assets/js/63.b9084887.js"><link rel="prefetch" href="/note/assets/js/64.e1d868ed.js"><link rel="prefetch" href="/note/assets/js/65.0d77e0a0.js"><link rel="prefetch" href="/note/assets/js/66.fe465e07.js"><link rel="prefetch" href="/note/assets/js/67.76ca73a0.js"><link rel="prefetch" href="/note/assets/js/68.2498dd7c.js"><link rel="prefetch" href="/note/assets/js/69.f03ab615.js"><link rel="prefetch" href="/note/assets/js/7.273a5831.js"><link rel="prefetch" href="/note/assets/js/70.cad85a7e.js"><link rel="prefetch" href="/note/assets/js/71.5dcb8b9a.js"><link rel="prefetch" href="/note/assets/js/72.827102a3.js"><link rel="prefetch" href="/note/assets/js/73.315b5fe4.js"><link rel="prefetch" href="/note/assets/js/74.def8de65.js"><link rel="prefetch" href="/note/assets/js/75.a54fced2.js"><link rel="prefetch" href="/note/assets/js/76.6cae1891.js"><link rel="prefetch" href="/note/assets/js/77.12cb32b9.js"><link rel="prefetch" href="/note/assets/js/78.5994be50.js"><link rel="prefetch" href="/note/assets/js/79.bbc37f01.js"><link rel="prefetch" href="/note/assets/js/8.ba3fa28e.js"><link rel="prefetch" href="/note/assets/js/80.eeb65418.js"><link rel="prefetch" href="/note/assets/js/81.f876286e.js"><link rel="prefetch" href="/note/assets/js/82.a58003e1.js"><link rel="prefetch" href="/note/assets/js/83.13c9c65b.js"><link rel="prefetch" href="/note/assets/js/84.dca226ee.js"><link rel="prefetch" href="/note/assets/js/85.38911042.js"><link rel="prefetch" href="/note/assets/js/86.4f2e3cde.js"><link rel="prefetch" href="/note/assets/js/87.bb576b86.js"><link rel="prefetch" href="/note/assets/js/88.ba3e1a83.js"><link rel="prefetch" href="/note/assets/js/89.cc281bcf.js"><link rel="prefetch" href="/note/assets/js/9.557b7160.js"><link rel="prefetch" href="/note/assets/js/90.b68af197.js"><link rel="prefetch" href="/note/assets/js/91.a0945e77.js"><link rel="prefetch" href="/note/assets/js/92.accc5e5d.js"><link rel="prefetch" href="/note/assets/js/93.682fd046.js"><link rel="prefetch" href="/note/assets/js/94.c47d39d0.js"><link rel="prefetch" href="/note/assets/js/95.6363826c.js"><link rel="prefetch" href="/note/assets/js/96.36edf40e.js"><link rel="prefetch" href="/note/assets/js/97.75b6c735.js"><link rel="prefetch" href="/note/assets/js/98.8b5d3421.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.ba589cc9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><img src="/note/favicon.png" alt="CHKAOS" class="logo"> <span class="site-name can-hide">CHKAOS</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/MIT/" class="nav-link">
  Mit
</a></div><div class="nav-item"><a href="/note/Leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/note/Interview/" class="nav-link">
  Interview
</a></div><div class="nav-item"><a href="http://chkaos.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/chkaos/note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/MIT/" class="nav-link">
  Mit
</a></div><div class="nav-item"><a href="/note/Leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/note/Interview/" class="nav-link">
  Interview
</a></div><div class="nav-item"><a href="http://chkaos.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/chkaos/note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/note/mit/" aria-current="page" class="sidebar-link">前言</a></li><li><a href="/note/mit/schedule.html" class="sidebar-link">计划</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机科学与编程导论(python)</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机科学数学</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>电子工程与计算机科学导论1</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>电子工程与计算机科学导论2(交流网络)</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法导论</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>软件构造</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络导论</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>操作系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>分布式系统</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/mit/fen-bu-shi-xi-tong/" aria-current="page" class="sidebar-link">6.824 分布式系统</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/01.html" class="sidebar-link">Introduction</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/02.html" class="sidebar-link">2: Infrastructure: RPC and threads</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/03.html" class="sidebar-link">3.Fault Tolerance: primary/backup replication</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/04.html" class="sidebar-link">4.Fault Tolerance: FDS Case Study</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/05.html" class="sidebar-link">5: Fault Tolerance:Paxos</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/06.html" class="sidebar-link">6: Fault Tolerance:Raft</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/07.html" class="sidebar-link">7.Guest lecturer: Russ Cox (Google/Go)</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/08.html" class="sidebar-link">8.Case Studies: Replicated File System -- Harp</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/09.html" class="sidebar-link">9. Distributed Computing: Sequential consistency</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/10.html" class="sidebar-link">10.Distributed Computing: Relaxed consistency</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/11.html" class="sidebar-link">11.Disconnected Operation: Version Vectors and File Synchronization</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/12.html" class="sidebar-link">13.Disconnected Operation: Eventual Consistency</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/13.html" class="sidebar-link">13.MapReduce revisited</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/14.html" class="sidebar-link">14.Spark Case Study</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/15.html" class="sidebar-link">15.Guest lecturer: Wilson Hsieh (Google)</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/16.html" class="sidebar-link">16.Scaling Memcache at Facebook</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/17.html" class="sidebar-link">17.Case Studies: Relaxed Consistency-PNUTS</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/18.html" aria-current="page" class="active sidebar-link">18. Case Studies:Dynamo</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/19.html" class="sidebar-link">19.Distributed systems in the real world (Guest lecturer: Emil Sit)</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/20.html" class="sidebar-link">20.Atomicity: Two-Phase Commit</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/21.html" class="sidebar-link">21.Atomicity: Optimistic Concurrency Control</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/22.html" class="sidebar-link">22.Peer-to-peer: Trackerless Bittorrent and DHTs</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/23.html" class="sidebar-link">23.Peer-to-peer: Bitcoin</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/24.html" class="sidebar-link">24.Project demos</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_18-case-studies-dynamo"><a href="#_18-case-studies-dynamo" class="header-anchor">#</a> 18. Case Studies:Dynamo</h1> <p>Dynamo: Amazon's Highly Available Key-value Store
DeCandia et al, SOSP 2007</p> <p>Why are we reading this paper?
Database, eventually consistent, write any replica
Like Ficus -- but a database! A surprising design.
A real system: used for e.g. shopping cart at Amazon
More available than PNUTS, Spanner, &amp;c
Less consistent than PNUTS, Spanner, &amp;c
Influential design; inspired e.g. Cassandra
2007: before PNUTS, before Spanner</p> <p>Their Obsessions
SLA, e.g. 99.9th percentile of delay &lt; 300 ms
constant failures
&quot;data centers being destroyed by tornadoes&quot;
&quot;always writeable&quot;</p> <p>Big picture
[lots of data centers, Dynamo nodes]
each item replicated at a few random nodes, by key hash</p> <p>Why replicas at just a few sites? Why not replica at every site?
with two data centers, site failure takes down 1/2 of nodes
so need to be careful that <em>everything</em> replicated at <em>both</em> sites
with 10 data centers, site failure affects small fraction of nodes
so just need copies at a few sites</p> <p>Consequences of mostly remote access (since no guaranteed local copy)
most puts/gets may involve WAN traffic -- high delays
maybe distinct Dynamo instances with limited geographical scope?
paper quotes low average delays in graphs but does not explain
more vulnerable to network failure than PNUTS
again since no local copy</p> <p>Consequences of &quot;always writeable&quot;
always writeable =&gt; no master! must be able to write locally.
always writeable + failures = conflicting versions</p> <p>Idea #1: eventual consistency
accept writes at any replica
allow divergent replicas
allow reads to see stale or conflicting data
resolve multiple versions when failures go away
latest version if no conflicting updates
if conflicts, reader must merge and then write
like Bayou and Ficus -- but in a DB</p> <p>Unhappy consequences of eventual consistency
May be no unique &quot;latest version&quot;
Read can yield multiple conflicting versions
Application must merge and resolve conflicts
No atomic operations (e.g. no PNUTS test-and-set-write)</p> <p>Idea #2: sloppy quorum
try to get consistency benefits of single master if no failures
but allows progress even if coordinator fails, which PNUTS does not
when no failures, send reads/writes through single node
the coordinator
causes reads to see writes in the usual case
but don't insist! allow reads/writes to any replica if failures</p> <p>Where to place data -- consistent hashing
[ring, and physical view of servers]
node ID = random
key ID = hash(key)
coordinator: successor of key
clients send puts/gets to coordinator
replicas at successors -- &quot;preference list&quot;
coordinator forwards puts (and gets...) to nodes on preference list</p> <p>Why consistent hashing?
Pro
naturally somewhat balanced
decentralized -- both lookup and join/leave
Con (section 6.2)
not really balanced (why not?), need virtual nodes
hard to control placement (balancing popular keys, spread over sites)
join/leave changes partition, requires data to shift</p> <p>Failures
Tension: temporary or permanent failure?
node unreachable -- what to do?
if temporary, store new puts elsewhere until node is available
if permanent, need to make new replica of all content
Dynamo itself treats all failures as temporary</p> <p>Temporary failure handling: quorum
goal: do not block waiting for unreachable nodes
goal: put should always succeed
goal: get should have high prob of seeing most recent put(s)
quorum: R + W &gt; N
never wait for all N
but R and W will overlap
cuts tail off delay distribution and tolerates some failures
N is first N <em>reachable</em> nodes in preference list
each node pings successors to keep rough estimate of up/down
&quot;sloppy&quot; quorum, since nodes may disagree on reachable
sloppy quorum means R/W overlap <em>not guaranteed</em></p> <p>coordinator handling of put/get:
sends put/get to first N reachable nodes, in parallel
put: waits for W replies
get: waits for R replies
if failures aren't too crazy, get will see all recent put versions</p> <p>When might this quorum scheme <em>not</em> provide R/W intersection?</p> <p>What if a put() leaves data far down the ring?
after failures repaired, new data is beyond N?
that server remembers a &quot;hint&quot; about where data really belongs
forwards once real home is reachable
also -- periodic &quot;merkle tree&quot; sync of key range</p> <p>How can multiple versions arise?
Maybe a node missed the latest write due to network problem
So it has old data, should be superseded by newer put()s
get() consults R, will likely see newer version as well as old</p> <p>How can <em>conflicting</em> versions arise?
N=3 R=2 W=2
shopping cart, starts out empty &quot;&quot;
preference list n1, n1, n3, n4
client 1 wants to add item X
get() from n1, n2, yields &quot;&quot;
n1 and n2 fail
put(&quot;X&quot;) goes to n3, n4
client 2 wants to delete X
get() from n3, n4, yields &quot;X&quot;
put(&quot;&quot;) to n3, n4
n1, n2 revive
client 3 wants to add Y
get() from n1, n2 yields &quot;&quot;
put(&quot;Y&quot;) to n1, n2
client 3 wants to display cart
get() from n1, n3 yields two values!
&quot;X&quot; and &quot;Y&quot;
neither supersedes the other -- the put()s conflicted</p> <p>How should clients resolve conflicts on read?
Depends on the application
Shopping basket: merge by taking union?
Would un-delete item X
Weaker than Bayou (which gets deletion right), but simpler
Some apps probably can use latest wall-clock time
E.g. if I'm updating my password
Simpler for apps than merging
Write the merged result back to Dynamo</p> <p>How to detect whether two versions conflict?
As opposed to a newer version superseding an older one
If they are not bit-wise identical, must client always merge+write?
We have seen this problem before...</p> <p>Version vectors
Example tree of versions:
[a:1]
[a:1,b:2]
VVs indicate v1 supersedes v2
Dynamo nodes automatically drop [a:1] in favor of [a:1,b:2]
Example:
[a:1]
[a:1,b:2]
[a:2]
Client must merge</p> <p>get(k) may return multiple versions, along with &quot;context&quot;
and put(k, v, context)
put context tells coordinator which versions this put supersedes/merges</p> <p>Won't the VVs get big?
Yes, but slowly, since key mostly served from same N nodes
Dynamo deletes least-recently-updated entry if VV has &gt; 10 elements</p> <p>Impact of deleting a VV entry?
won't realize one version subsumes another, will merge when not needed:
put@b: [b:4]
put@a: [a:3, b:4]
forget b:4: [a:3]
now, if you sync w/ [b:4], looks like a merge is required
forgetting the oldest is clever
since that's the element most likely to be present in other branches
so if it's missing, forces a merge
forgetting <em>newest</em> would erase evidence of recent difference</p> <p>Is client merge of conflicting versions always possible?
Suppose we're keeping a counter, x
x starts out 0
incremented twice
but failures prevent clients from seeing each others' writes
After heal, client sees two versions, both x=1
What's the correct merge result?
Can the client figure it out?</p> <p>What if two clients concurrently write w/o failure?
e.g. two clients add diff items to same cart at same time
Each does get-modify-put
They both see the same initial version
And they both send put() to same coordinator
Will coordinator create two versions with conflicting VVs?
We want that outcome, otherwise one was thrown away
Paper doesn't say, but coordinator could detect problem via put() context</p> <p>Permanent server failures / additions?
Admin manually modifies the list of servers
System shuffles data around -- this takes a long time!</p> <p>The Question:
It takes a while for notice of added/deleted server to become known
to all other servers. Does this cause trouble?
Deleted server might get put()s meant for its replacement.
Deleted server might receive get()s after missing some put()s.
Added server might miss some put()s b/c not known to coordinator.
Added server might serve get()s before fully initialized.
Dynamo probably will do the right thing:
Quorum likely causes get() to see fresh data as well as stale.
Replica sync (4.7) will fix missed get()s.</p> <p>Is the design inherently low delay?
No: client may be forced to contact distant coordinator
No: some of the R/W nodes may be distant, coordinator must wait</p> <p>What parts of design are likely to help limit 99.9th pctile delay?
This is a question about variance, not mean
Bad news: waiting for multiple servers takes <em>max</em> of delays, not e.g. avg
Good news: Dynamo only waits for W or R out of N
cuts off tail of delay distribution
e.g. if nodes have 1% chance of being busy with something else
or if a few nodes are broken, network overloaded, &amp;c</p> <p>No real Eval section, only Experience</p> <p>How does Amazon use Dynamo?
shopping cart (merge)
session info (maybe Recently Visited &amp;c?) (most recent TS)
product list (mostly r/o, replication for high read throughput)</p> <p>They claim main advantage of Dynamo is flexible N, R, W
What do you get by varying them?
N-R-W
3-2-2 : default, reasonable fast R/W, reasonable durability
3-3-1 : fast W, slow R, not very durable, not useful?
3-1-3 : fast R, slow W, durable
3-3-3 : ??? reduce chance of R missing W?
3-1-1 : not useful?</p> <p>They had to fiddle with the partitioning / placement / load balance (6.2)
Old scheme:
Random choice of node ID meant new node had to split old nodes' ranges
Which required expensive scans of on-disk DBs
New scheme:
Pre-determined set of Q evenly divided ranges
Each node is coordinator for a few of them
New node takes over a few entire ranges
Store each range in a file, can xfer whole file</p> <p>How useful is ability to have multiple versions? (6.3)
I.e. how useful is eventual consistency
This is a Big Question for them
6.3 claims 0.001% of reads see divergent versions
I believe they mean conflicting versions (not benign multiple versions)
Is that a lot, or a little?
So perhaps 0.001% of writes benefitted from always-writeable?
I.e. would have blocked in primary/backup scheme?
Very hard to guess:
They hint that the problem was concurrent writers, for which
better solution is single master
But also maybe their measurement doesn't count situations where
availability would have been worse if single master</p> <p>Performance / throughput (Figure 4, 6.1)
Figure 4 says average 10ms read, 20 ms writes
the 20 ms must include a disk write
10 ms probably includes waiting for R/W of N
Figure 4 says 99.9th pctil is about 100 or 200 ms
Why?
&quot;request load, object sizes, locality patterns&quot;
does this mean sometimes they had to wait for coast-coast msg?</p> <p>Puzzle: why are the average delays in Figure 4 and Table 2 so low?
Implies they rarely wait for WAN delays
But Section 6 says &quot;multiple datacenters&quot;
you'd expect <em>most</em> coordinators and most nodes to be remote!
Maybe all datacenters are near Seattle?</p> <p>Wrap-up
Big ideas:
eventual consistency
always writeable despite failures
allow conflicting writes, client merges
Awkward model for some applications (stale reads, merges)
this is hard for us to tell from paper
Maybe a good way to get high availability + no blocking on WAN
but PNUTS master scheme implies Yahoo thinks not a problem
No agreement on whether eventual consistency is good for storage systems</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">lastUpdate:</span> <span class="time">4/6/2021, 2:11:34 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/mit/fen-bu-shi-xi-tong/17.html" class="prev">
        17.Case Studies: Relaxed Consistency-PNUTS
      </a></span> <span class="next"><a href="/note/mit/fen-bu-shi-xi-tong/19.html">
        19.Distributed systems in the real world (Guest lecturer: Emil Sit)
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.d5006f3d.js" defer></script><script src="/note/assets/js/2.65e5b2f3.js" defer></script><script src="/note/assets/js/99.e03485fe.js" defer></script>
  </body>
</html>
