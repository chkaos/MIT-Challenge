<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>6: Fault Tolerance:Raft | CHKAOS</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/note/egg.png">
    <meta name="description" content="My Note Collection">
    
    <link rel="preload" href="/note/assets/css/0.styles.ba589cc9.css" as="style"><link rel="preload" href="/note/assets/js/app.d5006f3d.js" as="script"><link rel="preload" href="/note/assets/js/2.65e5b2f3.js" as="script"><link rel="preload" href="/note/assets/js/87.bb576b86.js" as="script"><link rel="prefetch" href="/note/assets/js/10.ae2f2d04.js"><link rel="prefetch" href="/note/assets/js/100.c68d38be.js"><link rel="prefetch" href="/note/assets/js/101.fd3e754f.js"><link rel="prefetch" href="/note/assets/js/102.5c217b08.js"><link rel="prefetch" href="/note/assets/js/103.449bcd79.js"><link rel="prefetch" href="/note/assets/js/104.1b5b375d.js"><link rel="prefetch" href="/note/assets/js/105.a61b2017.js"><link rel="prefetch" href="/note/assets/js/106.e81cfff0.js"><link rel="prefetch" href="/note/assets/js/107.a75923b3.js"><link rel="prefetch" href="/note/assets/js/108.891948b3.js"><link rel="prefetch" href="/note/assets/js/109.a2545875.js"><link rel="prefetch" href="/note/assets/js/11.4ab4a5a3.js"><link rel="prefetch" href="/note/assets/js/110.6d0886e8.js"><link rel="prefetch" href="/note/assets/js/12.255d9150.js"><link rel="prefetch" href="/note/assets/js/13.794e7ac8.js"><link rel="prefetch" href="/note/assets/js/14.d32c7fdd.js"><link rel="prefetch" href="/note/assets/js/15.67cfbf95.js"><link rel="prefetch" href="/note/assets/js/16.3c73a976.js"><link rel="prefetch" href="/note/assets/js/17.8806b699.js"><link rel="prefetch" href="/note/assets/js/18.378bd860.js"><link rel="prefetch" href="/note/assets/js/19.48c8434f.js"><link rel="prefetch" href="/note/assets/js/20.1fdb582e.js"><link rel="prefetch" href="/note/assets/js/21.3e08c9be.js"><link rel="prefetch" href="/note/assets/js/22.810fe1a0.js"><link rel="prefetch" href="/note/assets/js/23.5ba70e2d.js"><link rel="prefetch" href="/note/assets/js/24.9681b927.js"><link rel="prefetch" href="/note/assets/js/25.c0e5deaa.js"><link rel="prefetch" href="/note/assets/js/26.aae4bdc7.js"><link rel="prefetch" href="/note/assets/js/27.7f17e5f5.js"><link rel="prefetch" href="/note/assets/js/28.61ef96a0.js"><link rel="prefetch" href="/note/assets/js/29.f8d63307.js"><link rel="prefetch" href="/note/assets/js/3.031640f4.js"><link rel="prefetch" href="/note/assets/js/30.817d5cd9.js"><link rel="prefetch" href="/note/assets/js/31.e4ea696a.js"><link rel="prefetch" href="/note/assets/js/32.aba63c9c.js"><link rel="prefetch" href="/note/assets/js/33.1aa6facd.js"><link rel="prefetch" href="/note/assets/js/34.69d2bc3f.js"><link rel="prefetch" href="/note/assets/js/35.f82bd55f.js"><link rel="prefetch" href="/note/assets/js/36.20a42b33.js"><link rel="prefetch" href="/note/assets/js/37.7ab6c748.js"><link rel="prefetch" href="/note/assets/js/38.04cf7e1e.js"><link rel="prefetch" href="/note/assets/js/39.87ad9256.js"><link rel="prefetch" href="/note/assets/js/4.0876ef1d.js"><link rel="prefetch" href="/note/assets/js/40.fa12820d.js"><link rel="prefetch" href="/note/assets/js/41.22bd816e.js"><link rel="prefetch" href="/note/assets/js/42.c107915c.js"><link rel="prefetch" href="/note/assets/js/43.983b5fc5.js"><link rel="prefetch" href="/note/assets/js/44.75f6ceb2.js"><link rel="prefetch" href="/note/assets/js/45.98830da6.js"><link rel="prefetch" href="/note/assets/js/46.550f0b22.js"><link rel="prefetch" href="/note/assets/js/47.8fbd223c.js"><link rel="prefetch" href="/note/assets/js/48.edf4b3f9.js"><link rel="prefetch" href="/note/assets/js/49.7508a3de.js"><link rel="prefetch" href="/note/assets/js/5.369c3e08.js"><link rel="prefetch" href="/note/assets/js/50.04715961.js"><link rel="prefetch" href="/note/assets/js/51.277d9998.js"><link rel="prefetch" href="/note/assets/js/52.ebc26274.js"><link rel="prefetch" href="/note/assets/js/53.471c676f.js"><link rel="prefetch" href="/note/assets/js/54.9e46fdf4.js"><link rel="prefetch" href="/note/assets/js/55.8a98c441.js"><link rel="prefetch" href="/note/assets/js/56.b5f6e00a.js"><link rel="prefetch" href="/note/assets/js/57.f6fb0c39.js"><link rel="prefetch" href="/note/assets/js/58.d92a7b7d.js"><link rel="prefetch" href="/note/assets/js/59.33c88c84.js"><link rel="prefetch" href="/note/assets/js/6.34251819.js"><link rel="prefetch" href="/note/assets/js/60.68db27af.js"><link rel="prefetch" href="/note/assets/js/61.ce3eefe1.js"><link rel="prefetch" href="/note/assets/js/62.a3e76ed5.js"><link rel="prefetch" href="/note/assets/js/63.b9084887.js"><link rel="prefetch" href="/note/assets/js/64.e1d868ed.js"><link rel="prefetch" href="/note/assets/js/65.0d77e0a0.js"><link rel="prefetch" href="/note/assets/js/66.fe465e07.js"><link rel="prefetch" href="/note/assets/js/67.76ca73a0.js"><link rel="prefetch" href="/note/assets/js/68.2498dd7c.js"><link rel="prefetch" href="/note/assets/js/69.f03ab615.js"><link rel="prefetch" href="/note/assets/js/7.273a5831.js"><link rel="prefetch" href="/note/assets/js/70.cad85a7e.js"><link rel="prefetch" href="/note/assets/js/71.5dcb8b9a.js"><link rel="prefetch" href="/note/assets/js/72.827102a3.js"><link rel="prefetch" href="/note/assets/js/73.315b5fe4.js"><link rel="prefetch" href="/note/assets/js/74.def8de65.js"><link rel="prefetch" href="/note/assets/js/75.a54fced2.js"><link rel="prefetch" href="/note/assets/js/76.6cae1891.js"><link rel="prefetch" href="/note/assets/js/77.12cb32b9.js"><link rel="prefetch" href="/note/assets/js/78.5994be50.js"><link rel="prefetch" href="/note/assets/js/79.bbc37f01.js"><link rel="prefetch" href="/note/assets/js/8.ba3fa28e.js"><link rel="prefetch" href="/note/assets/js/80.eeb65418.js"><link rel="prefetch" href="/note/assets/js/81.f876286e.js"><link rel="prefetch" href="/note/assets/js/82.a58003e1.js"><link rel="prefetch" href="/note/assets/js/83.13c9c65b.js"><link rel="prefetch" href="/note/assets/js/84.dca226ee.js"><link rel="prefetch" href="/note/assets/js/85.38911042.js"><link rel="prefetch" href="/note/assets/js/86.4f2e3cde.js"><link rel="prefetch" href="/note/assets/js/88.ba3e1a83.js"><link rel="prefetch" href="/note/assets/js/89.cc281bcf.js"><link rel="prefetch" href="/note/assets/js/9.557b7160.js"><link rel="prefetch" href="/note/assets/js/90.b68af197.js"><link rel="prefetch" href="/note/assets/js/91.a0945e77.js"><link rel="prefetch" href="/note/assets/js/92.accc5e5d.js"><link rel="prefetch" href="/note/assets/js/93.682fd046.js"><link rel="prefetch" href="/note/assets/js/94.c47d39d0.js"><link rel="prefetch" href="/note/assets/js/95.6363826c.js"><link rel="prefetch" href="/note/assets/js/96.36edf40e.js"><link rel="prefetch" href="/note/assets/js/97.75b6c735.js"><link rel="prefetch" href="/note/assets/js/98.8b5d3421.js"><link rel="prefetch" href="/note/assets/js/99.e03485fe.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.ba589cc9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><img src="/note/favicon.png" alt="CHKAOS" class="logo"> <span class="site-name can-hide">CHKAOS</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/MIT/" class="nav-link">
  Mit
</a></div><div class="nav-item"><a href="/note/Leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/note/Interview/" class="nav-link">
  Interview
</a></div><div class="nav-item"><a href="http://chkaos.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/chkaos/note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/MIT/" class="nav-link">
  Mit
</a></div><div class="nav-item"><a href="/note/Leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/note/Interview/" class="nav-link">
  Interview
</a></div><div class="nav-item"><a href="http://chkaos.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/chkaos/note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/note/mit/" aria-current="page" class="sidebar-link">前言</a></li><li><a href="/note/mit/schedule.html" class="sidebar-link">计划</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机科学与编程导论(python)</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机科学数学</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>电子工程与计算机科学导论1</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>电子工程与计算机科学导论2(交流网络)</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法导论</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>软件构造</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络导论</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>操作系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>分布式系统</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/mit/fen-bu-shi-xi-tong/" aria-current="page" class="sidebar-link">6.824 分布式系统</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/01.html" class="sidebar-link">Introduction</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/02.html" class="sidebar-link">2: Infrastructure: RPC and threads</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/03.html" class="sidebar-link">3.Fault Tolerance: primary/backup replication</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/04.html" class="sidebar-link">4.Fault Tolerance: FDS Case Study</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/05.html" class="sidebar-link">5: Fault Tolerance:Paxos</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/06.html" aria-current="page" class="active sidebar-link">6: Fault Tolerance:Raft</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/07.html" class="sidebar-link">7.Guest lecturer: Russ Cox (Google/Go)</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/08.html" class="sidebar-link">8.Case Studies: Replicated File System -- Harp</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/09.html" class="sidebar-link">9. Distributed Computing: Sequential consistency</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/10.html" class="sidebar-link">10.Distributed Computing: Relaxed consistency</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/11.html" class="sidebar-link">11.Disconnected Operation: Version Vectors and File Synchronization</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/12.html" class="sidebar-link">13.Disconnected Operation: Eventual Consistency</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/13.html" class="sidebar-link">13.MapReduce revisited</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/14.html" class="sidebar-link">14.Spark Case Study</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/15.html" class="sidebar-link">15.Guest lecturer: Wilson Hsieh (Google)</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/16.html" class="sidebar-link">16.Scaling Memcache at Facebook</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/17.html" class="sidebar-link">17.Case Studies: Relaxed Consistency-PNUTS</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/18.html" class="sidebar-link">18. Case Studies:Dynamo</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/19.html" class="sidebar-link">19.Distributed systems in the real world (Guest lecturer: Emil Sit)</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/20.html" class="sidebar-link">20.Atomicity: Two-Phase Commit</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/21.html" class="sidebar-link">21.Atomicity: Optimistic Concurrency Control</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/22.html" class="sidebar-link">22.Peer-to-peer: Trackerless Bittorrent and DHTs</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/23.html" class="sidebar-link">23.Peer-to-peer: Bitcoin</a></li><li><a href="/note/mit/fen-bu-shi-xi-tong/24.html" class="sidebar-link">24.Project demos</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_6-fault-tolerance-raft"><a href="#_6-fault-tolerance-raft" class="header-anchor">#</a> 6: Fault Tolerance:Raft</h1> <p>this lecture
larger topic is fault tolerance via replicated state machines
Raft -- a much more complete design than straight Paxos</p> <p>Russ Cox of Google will talk about Go on Thursday
submit your questions early, so we can get them to Russ</p> <p>Raft overview
clients -&gt; leader -&gt; followers -&gt; logs -&gt; execution</p> <p>Raft vs Paxos?
Our use of Paxos:
agrees separately on each client operation
Raft:
agrees on each new leader (and on tail of log)
agreement not required for most client operations
Raft is Paxos optimized for log appends (more or less)
why Raft-style leader?
no dueling proposers (unless leader fails)
fewer messages, less complexity (unless leader fails)
well-defined notion of one log being more complete than another
simplifies switching leaders (and maybe crash recovery)</p> <p>what about understandability?
you must decide for yourself
straight Paxos is simpler than Raft
but straight Paxos is too simple for practical replication
everyone extends it in their own way
and ends up with something more or less like Raft
Paxos+log+leader probably not simpler than Raft
though presumably depends on which Paxos variant you choose</p> <p>is more direct use of Paxos (like Lab 3) ever a win?
i.e. is a Raft-style leader ever a bad idea?
geographically spread peers
a single leader would be far from some clients
some peers would be slow to other peers (paxos tolerates lag)</p> <p>let's start w/ Raft w/ no leader change
for now, reliable leader
followers may be slow or unreachable (but they do not lose state)
what do we want?
1. tolerate a minority of failed followers
2. converge on same log`
since replication requires same order of execution
3. execute only when entry cannot be lost (committed)
since cannot easily un-do execution or reply to client
idea for ensuring identical log:
leader sends log entry, index, and info about <em>previous</em> entry
client can reject (e.g I don't have previous entry!)
leader backs up for that follower, sends earlier entries
-&gt; leader forces followers' logs to be identical to leader's
idea for execution:
idea #1 means leader knows follower is identical up to some point
once a majority are identical up to a point,
leader sends that out as commit point,
everyone can execute through that point,
leader can reply to clients</p> <p>what to do if the leader crashes?
other servers time out (no AppendEntries &quot;heart-beats&quot; for a while)
choose a new leader!
Raft divides time into terms
most terms have a leader</p> <p>what are the dangers in transition to a new leader?
two leaders
no leader
might forget an executed log entry
logs might end up different (diverge)</p> <p>leader election first, then log consistency at term boundary</p> <p>how to ensure at most one leader in a term?
(look at Figure 2, RequestVote RPC, and Rules for Servers)
leader must get votes from a majority of servers
server can cast only one vote per term
thus at most one server can think it has won
why a majority?
the answer is always the same!
allows fault tolerance (failure of minority doesn't impede progress)
prevents split brain (at most one candidate can get a majority)
ensures overlap (at least one in majority has every previously committed log entry)</p> <p>could election fail to choose any leader?
yes!</p> <blockquote><p>= 3 candidates split the vote evenly
or even # of live servers, two candidates each get half</p></blockquote> <p>what happens after an election in which no-one gets majority?
timeout, increment term, new election
higher term takes precedence, candidates for older terms quit
note: timeout must be longer than it takes to complete election!
note: this means some terms may have no leader, no log entries</p> <p>how does Raft reduce chances of election failure due to split vote?
each server delays a random amount of time before starting candidacy
why is the random delay useful?
[diagram of times at which servers' delays expire]
one will choose lowest random delay
hopefully enough time to elect before next delay expires</p> <p>how to choose the random delay range?
too short: 2nd candidate starts before first finishes
too long: system sits idle for too long after leader fails
a rough guide:
suppose it takes 10ms to complete an unopposed election
and there are five servers
we want delays to be separated by (say) 20ms
so random delay from 0 to 100 ms
plus a few multiples of leader heartbeat interval</p> <p>remember this random delay idea!
it's a classic scheme for decentralized soft election; e.g. ethernet</p> <p>Raft's elections follow a common pattern: separation of safety from progress
<em>hard</em> mechanisms ensure &lt; 2 leaders in one term
problem: elections can fail (e.g. 3-way split)
solution: always safe to start a new election in a new term
problem: repeated elections can prevent any work getting done
solution: <em>soft</em> mechanisms reduce probability of wasted elections
heartbeat from leader (remind servers not to start election)
timeout period (don't start election too soon)
random delays (give one leader time to be elected)</p> <p>what if old leader isn't aware a new one is elected?
perhaps b/c old leader didn't see election messages
new leader means a majority of servers have incremented currentTerm
so old leader (w/ old term) can't get majority for AppendEntries
though a minority may accept old server's log entries...
so logs may diverge at end of old term...</p> <p>now let's switch topics to data handling at term boundaries</p> <p>what do we want to ensure?
each server executes the same client cmds, in the same order
i.e. if any server executes, then no server executes something
else for that log entry
as long as single leader, we've already seen it makes logs identical
what about when leader changes?</p> <p>what's the danger?
leader of term 3 crashed while sending AppendEntries
S1: 3
S2: 3 3
S3: 3 3
S2 and S3 might have executed; does Raft preserve it?
may be a series of crashes, e.g.
S1: 3
S2: 3 3 4
S3: 3 3 5
thus diff entries for the same index!</p> <p>roll-back is a big hammer -- forces leader's log on everyone
in above examples, whoever is elected imposes log on everyone
example:
S3 is chosen as new leader for term 6
S3 wants to send out a new entry (in term 6)
AppendEntries says previous entry must have term 5
S2 replies false (AppendEntries step 2)
S3 decrements nextIndex[S2]
AppendEntries for the term=5 op, saying prev has term=3
S2 deletes op from term 4 (AppendEntries step 3)
(and S1 rejects b/c it doesn't have anything in that entry)</p> <p>ok, leader will force its own log on followers
but that's not enough!
can roll-back delete an executed entry?</p> <p>when is a log entry executed?
when leader advances commitIndex/leaderCommit
when a majority match the leader up through this point</p> <p>could new leader roll back executed entries from end of previous term?
i.e. could an executed entry be missing from the new leader's log?
Raft needs to ensure new leader's log contains every potentially executed entry
i.e. must forbid election of server who might be missing an executed entry</p> <p>what are the election rules?
Figure 2 says only vote if candidate's log &quot;at least as up to date&quot;
So leader will be at least as up to date as a majority</p> <p>what does &quot;at least as up to date&quot; mean?
could it mean log is &gt;= length?
no; example:
S1: 5 6 7
S2: 5 8
S3: 5 8
first, could this scenario happen? how?
S1 leader in epoch 6; crash+reboot; leader in epoch 7; crash and stay down
both times it crashed after only appending to its own log
S2 leader in epoch 8, only S2+S3 alive, then crash
who should be next leader?
S1 has longest log, but entry 8 is committed !!!
Raft adopts leader's log, so S1 as leader -&gt; un-commit entry 8
incorrect since S2 may have replied to client
so new leader can only be one of S2 or S3
i.e. the rule cannot be simply &quot;longest log&quot;</p> <p>end of 5.4.1 explains &quot;at least as up to date&quot; voting rule
compare last entry
higher term wins
if equal terms, longer log wins</p> <p>so:
S1 can't get any vote from S2 or S3, since 7 &lt; 8
S1 will vote for either S2 or S3, since 8 &gt; 7
S1's operations from terms 6 and 7 will be discarded!
ok since no majority -&gt; not executed -&gt; no client reply</p> <p>the point:
&quot;at least as up to date&quot; rule causes new leader to have all executed
entries in its log
so new leader won't roll back any executed operation
similar to Paxos: new round ends up using chosen value (if any) of prev round</p> <p>The Question
figure 7, which of a/d/f could be elected?
i.e. majority of votes from &quot;less up to date&quot; servers?</p> <p>the most subtle thing about Raft (figure 8)
not 100% true that a log entry on a majority is committed
i.e. will never be forgotten
figure 8 describes an exception
S1: 1 2 4
S2: 1 2
S3: 1 2
S4: 1
S5: 1 3
S1 was leader in term 2, sends out two copies of 2
S5 leader in term 3
S1 in term 4, sends one more copy of 2 (b/c S3 rejected op 4)
what if S5 now becomes leader?
S5 can get a majority (w/o S1)
S5 will roll back 2 and replace it with 3
could 2 have executed?
it is on a majority...
so could S1 have mentioned it in leaderCommit after majority?
no! very end of Figure 2 says &quot;log[N].term == currentTerm&quot;
and S1 was in term 4 when sending 3rd copy of 2
what's Raft's actual commit point?
bottom-right of page 310
&quot;committed once the leader that created the entry has replicated on majority&quot;
and commit point of one entry commits all before it
which is how 2 <em>could</em> have committed if S1 hadn't lost leadership</p> <p>another topic: configuration change (Section 6)
configuration = set of servers
how does Raft change the set of servers?
e.g. every few years might want to retire some, add some
or move all at once to an entirely new set of server
or increase/decrease the number of servers</p> <p>how might a <em>broken</em> configuration change work?
each server has the list of servers in the current config
change configuation by changing lists, one by one
example: want to replace S3 with S4
S1: 1,2,3  1,2,4
S2: 1,2,3  1,2,3
S3: 1,2,3  1,2,3
S4: 1,2,4  1,2,4
OOPS!
now <em>two</em> disjoint group/leaders can form:
S2 and S3 (who know nothing of new config)
S1 and S4
both can process client requests, so split brain</p> <p>Raft configuration change
idea: &quot;join consensus&quot; stage that includes <em>both</em> old and new configuration
leader of old group logs entry that switches to joint consensus
during joint consensus, leader separately logs in old and new
i.e. <em>two</em> log and <em>two</em> agreements on each log entry
this will force new servers to catch up
and force new and old logs to be the same
after majority of old and new have switched to joint consensus,
leader logs entry that switches to final configuration
S1: 1,2,3  1,2,3+1,2,4
S2: 1,2,3
S3: 1,2,3
S4:        1,2,3+1,2,4
if crash but new leader didn't see the switch to joint consensus,
then old group will continue, no switch, but that's OK
if crash and new leader did see the switch to joint consensus,
it will complete the configuration change</p> <p>performance
no numbers on how fast it can process requests
what are the bottlenecks likely to be?
disk:
need to write disk for client data durability, and for protocol promises
write per client request? so 100 per second?
could probably batch and get 10,000 to 100,000
net: a few message exchanges per client request
10s of microseconds for local LAN message exchange?
so 100,000 per second?</p> <p>Thursday: Russ Cox of Google on Go</p> <p>next week: use of a Raft-like protocol in a complex application</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">lastUpdate:</span> <span class="time">4/6/2021, 2:11:34 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/mit/fen-bu-shi-xi-tong/05.html" class="prev">
        5: Fault Tolerance:Paxos
      </a></span> <span class="next"><a href="/note/mit/fen-bu-shi-xi-tong/07.html">
        7.Guest lecturer: Russ Cox (Google/Go)
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.d5006f3d.js" defer></script><script src="/note/assets/js/2.65e5b2f3.js" defer></script><script src="/note/assets/js/87.bb576b86.js" defer></script>
  </body>
</html>
